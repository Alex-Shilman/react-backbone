/*!
 * https://github.com/jhudson8/react-backbone;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=e:e(React,Backbone,_)}(function(React,Backbone,_){!function(){function e(e){e=e||"_all";var n=u[e];return n||(n=function(n,a){"_all"!==e&&(options=a,a=n,n=e),t(a.method,this,a.model,a.options)},u[e]=n),n}function t(e,t,r,d){function u(e){var i=d[e];d[e]=function(r,o,s){if(e!==c||p.preventDefault||(p.trigger("after-send",r,o,s,e,p),r=p.data||r,!p.preventDefault)){try{i&&i.call(this,r,o,s)}finally{var l=f.indexOf(p);l>=0&&f.splice(l,1),0===f.length&&(t[a]=void 0,t.trigger(n,p))}var d=e===c?[e,p]:[e,r,o,s,p];p.trigger.apply(p,d),d.splice(0,0,"complete"),p.trigger.apply(p,d)}}}var f=t[a]=t[a]||[],h=d&&d.event||e,p=new l(e,r,d),v=i+":"+h;t.trigger(i,h,p),t.trigger(v,p),t===r&&(o.trigger(i,h,t,p),o.trigger(v,t,p));var m=d.beforeSend;return d.beforeSend=function(e,t){if(p.xhr=e,p.settings=t,m){var n=m.call(this,e,t);if(n===!1)return n}return p.trigger("before-send",e,t,p),p.preventDefault?!1:void f.push(p)},u(c),u(s),p}var n=Backbone.xhrCompleteEventName=Backbone.xhrCompleteEventName||"xhr:complete",a=Backbone.xhrModelLoadingAttribute=Backbone.xhrModelLoadingAttribute||"xhrActivity",i=Backbone.xhrEventName=Backbone.xhrEventName||"xhr",r=Backbone.xhrGlobalAttribute=Backbone.xhrGlobalAttribute||"xhrEvents",o=Backbone[r]=_.extend({},Backbone.Events),c="success",s="error",l=function(e,t,n){this.method=e,this.model=t,this.options=n};l.prototype.abort=function(){this.aborted||(this.aborted=!0,this.preventDefault=!0,this.xhr&&this.xhr.abort())},_.extend(l.prototype,Backbone.Events);var d=Backbone.sync;Backbone.sync=function(e,n,a){a=a||{},a.url||(a.url=_.result(n,"url"));var i=t(e,n,n,a);if(!i.preventDefault){var r=d.call(this,e,n,a);return i.xhr=r,r}},o.on(i+":read",function(e,t){t.on(c,function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on(s,function(){e.hadFetchError=!0})}),Backbone.Model.prototype.whenFetched=Backbone.Collection.whenFetched=function(e,t){function n(){e(i)}var i=this;if(this.hasBeenFetched)return e(this);var r=_.find(this[a],function(e){return"read"===e.method});r?(r.on("success",n),t&&r.on("error",t)):this.fetch({success:n,error:t})},Backbone.forwardXhrEvents=function(t,n,a){var r=e(!_.isFunction(a)&&a);if(_.isFunction(a))try{t.on(i,r,n),a.call(this)}finally{t.off(i,r,n)}else{var o=a?i+":"+a:i;t.on(o,r,n)}},Backbone.stopXhrForwarding=function(t,n,a){var r=e(a);t.off(i,r,n)};var u={};_.each({reset:Backbone.Collection,clear:Backbone.Model},function(e,t){var n=e.prototype[t];e.prototype[t]=function(e){("clear"===t||_.isUndefined(e))&&(this.hasBeenFetched=this.hadFetchError=!1),n.apply(this,arguments)}})}(),function(){function setState(e,t){if(t.isMounted())t.setState(e);else if(t.state)for(var n in e)t.state[n]=e[n];else{var a=t.__temporary_state||{};for(var n in e)a[n]=e[n];t.__temporary_state=a}}function getState(e,t){var n=t.state,a=t.__temporary_state;return n&&n[e]||a&&a[e]}function get(values,index,initiatedOnce,rtn){function addTo(name){var indexName=name,match=name.match(/^([^\(]*)\s*\(([^\)]*)\)\s*/),params=match&&match[2];if(name=match&&match[1]||name,!index[indexName]){params&&(params=eval("["+params+"]"));var mixin=_mixins[name],checkAgain=!1,skip=!1;if(!mixin)throw new Error('invalid mixin "'+name+'"');if("function"==typeof mixin)_initiatedOnce[name]?(initiatedOnce[name]=initiatedOnce[name]||[],initiatedOnce[name].push(params),skip=!0):(mixin=mixin.apply(this,params||[]),checkAgain=!0);else if(params)throw new Error('the mixin "'+name+'" does not support parameters');get(_dependsOn[name],index,initiatedOnce,rtn),get(_dependsInjected[name],index,initiatedOnce,rtn),index[indexName]=!0,checkAgain?get([mixin],index,initiatedOnce,rtn):skip||rtn.push(mixin)}}function handleMixin(e){if(e)if(Array.isArray(e))get(e,index,initiatedOnce,rtn);else if("string"==typeof e)addTo(e);else{if(e.mixins){get(e.mixins,index,initiatedOnce,rtn);var t=_mixins[e];if(!t){t={};for(var n in e)"mixins"!==n&&(t[n]=e[n])}_mixins[e]=t,e=t}rtn.push(e)}}if(Array.isArray(values))for(var i=0;i<values.length;i++)handleMixin(values[i]);else handleMixin(values)}function getInitiatedOnce(e,t){function n(e,n){e=e.apply(this,n||[]),t.push(e)}for(var a in e)e.hasOwnProperty(a)&&n(_mixins[a],e[a])}function addMixin(e,t,n,a,i){React.mixins;(a||!_mixins[e])&&(_dependsOn[e]=n.length&&n,_mixins[e]=t,i&&(_initiatedOnce[e]=!0))}function GROUP(){}function mixinParams(e,t){var n,a=e[0],i=!1;if("object"==typeof a?(n=a.name,i=a.initiatedOnce):n=a,!n||!n.length)throw new Error("the mixin name hasn't been specified");return Array.isArray(e[1])?[n,e[1][0],Array.prototype.slice.call(e[1],1),t,i]:[n,e[1],Array.prototype.slice.call(e,2),t,i]}var _dependsOn={},_dependsInjected={},_mixins={},_initiatedOnce={},_createClass=React.createClass;React.createClass=function(e){return e.mixins&&(e.mixins=React.mixins.get(e.mixins)),_createClass.apply(React,arguments)},React.mixins={get:function(){var e=[],t={},n={};return get(Array.prototype.slice.call(arguments),t,n,e),getInitiatedOnce(n,e),e},inject:function(e){var t=_dependsInjected[e];t||(t=_dependsInjected[e]=[]),t.push(Array.prototype.slice.call(arguments,1))},alias:function(e){addMixin(e,GROUP,Array.prototype.slice.call(arguments,1),!1)},add:function(){addMixin.apply(this,mixinParams(arguments,!1))},replace:function(){addMixin.apply(this,mixinParams(arguments,!0))},exists:function(e){return _mixins[e]||!1},_reset:function(){_dependsOn={},_mixins={},_dependsInjected={},_onceInitiated={}}},React.mixins.add("deferUpdate",{getInitialState:function(){return{}},deferUpdate:function(){var e=this.state;if(!e._deferUpdate){e._deferUpdate=!0;var t=this;setTimeout(function(){delete e._deferUpdate,t.isMounted()&&t.forceUpdate()},0)}}}),React.mixins.add("state",{getInitialState:function(){return{}},componentWillMount:function(){var e=this.__temporary_state;if(e){for(var t in e)this.state[t]=e[t];delete this.__temporary_state}}}),React.mixins.setState=setState,React.mixins.getState=getState}(),function(){function normalizeEvents(e,t,n){t=t||{},n?n+=":":n="";var a,i;for(var r in e)a=e[r],i=typeof a,"string"===i||"function"===i?t[n+r]=a:a&&normalizeEvents(a,t,n+r);return t}function manageEvent(e,t){var n={type:e};for(var a in t)n[a]=t[a];var i=React.mixins.getState("__watchedEvents",this);i||(i=[],setState({__watchedEvents:i},this)),n.context=n.context||this,i.push(n);var r=getTarget(n.target,this);if(this.isMounted()&&r&&r[n.type](n.event,n.callback,n.context),"off"===e)for(var o,c=0;c<i.length;c++)o=i[c],o.event===t.event&&o.callback===t.callback&&getTarget(o.target,this)===r&&i.splice(c,1)}function _watchedEventsBindAll(e){var t=getState("__watchedEvents",e);if(t){var n;for(var a in t){n=t[a];var i=getTarget(n.target,e);i&&i[n.type](n.event,n.callback,n.context)}}}function _watchedEventsUnbindAll(e,t){var n=getState("__watchedEvents",t);if(n){var a;for(var i in n){a=n[i];var r=getTarget(a.target,t);r&&r.off(a.event,a.callback,a.context)}e||setState({__watchedEvents:[]},t)}}function getTarget(e,t){return"function"==typeof e?e.call(t):e}function createHandler(event,callback,context,dontWrapCallback){if(!dontWrapCallback){var _callback=callback,noArg;if("object"==typeof callback&&(_callback=callback.callback.call(this)),"string"==typeof callback&&(noArg=noArgMethods.indexOf(callback)>=0,_callback=context[callback]),!_callback)throw'no callback function exists for "'+callback+'"';callback=function(){return _callback.apply(context,noArg?[]:arguments)}}var match=event.match(specialWrapper);if(match){var specialMethodName=match[1],args=eval("["+match[2]+"]"),rest=match[3],specialHandler=React.events.specials[specialMethodName];if(specialHandler)return 1===args.length&&""===args[0]&&(args=[]),callback=specialHandler.call(context,callback,args),createHandler(rest,callback,context,!0);throw new Error('invalid special event handler "'+specialMethodName+"'")}var parts=event.match(splitter),handlerName=parts[1];path=parts[2],handler=handlers[handlerName];for(var i=0;!handler&&i<patternHandlers.length;i++)handlerName.match(patternHandlers[i].pattern)&&(handler=patternHandlers[i].handler);if(!handler)throw new Error('no handler registered for "'+event+'"');return handler.call(context,{key:handlerName,path:path},callback)}function registerObjectHandler(e,t){eventManager.handle(e,function(e,n){var a,i,r=e.path.match(splitter),o=r[1],c=r[2];return{on:function(){var e=t.call(this,o);e&&(i=e.state||e,e.on(c,n),a=e)},off:function(){a&&(a.off(c,n),a=void 0,i=void 0)},isStale:function(){if(!a)return!!e;var e=t.call(this,o);return e&&(e.state||e)===i?void 0:!0}}})}var handlers={},patternHandlers=[],splitter=/^([^:]+):?(.*)/,specialWrapper=/^\*([^\(]+)\(([^)]*)\)[->:]*(.*)/,noArgMethods=["forceUpdate"],setState=React.mixins.setState,getState=React.mixins.getState,handlerTemplates={standard:function(e){var t={on:e.onKey||"on",off:e.offKey||"off"},n=e.target;return function(a,i){function r(e,a){return function(){var r="function"==typeof n?n.call(a,o):n;r&&r[t[e]](o,i)}}var o=a.path;return{on:r("on",this),off:r("off",this),initialize:e.initialize}}}},eventManager=React.events={specials:{},handle:function(e,t){"function"!=typeof t&&(t=handlerTemplates[t.type||"standard"](t)),e instanceof RegExp?patternHandlers.push({pattern:e,handler:t}):handlers[e]=t}};"undefined"!=typeof window&&eventManager.handle("window",{target:window,onKey:"addEventListener",offKey:"removeEventListener"});var objectHandlers={ref:function(e){return this.refs[e]},prop:function(e){return this.props[e]}},objectFactory;for(var key in objectHandlers)registerObjectHandler(key,objectHandlers[key]);eventManager.handle("repeat",function(e,t){var n,a=parseInt(e.path,10);return{on:function(){n=setInterval(t,a)},off:function(){n=!!clearInterval(n)}}}),eventManager.handle("!repeat",function(e,t){function n(e){e!==!0&&t(),setTimeout(function(){a&&requestAnimationFrame(n)},i)}var a,i=parseInt(e.path,10);return{on:function(){a=!0,n(!0)},off:function(){a=!1}}}),React.mixins.add("events",function(){function e(e,t){return function(){e.apply(t,arguments)}}var t=[{triggerWith:function(){var e=Array.prototype.slice.call(arguments),t=this;return function(){t.trigger.apply(t,e)}},callWith:function(e){var t=Array.prototype.slice.call(arguments,1),n=this;return function(){e.apply(n,t)}},getInitialState:function(){var e=[];if(this.events){var t,n=normalizeEvents(this.events);for(var a in n)t=createHandler(a,n[a],this),t.initialize&&t.initialize.call(this),e.push(t)}return{_eventHandlers:e}},componentDidUpdate:function(){for(var e,t=getState("_eventHandlers",this),n=0;n<t.length;n++)e=t[n],e.isStale&&e.isStale.call(this)&&(e.off.call(this),e.on.call(this))},componentDidMount:function(){for(var e=getState("_eventHandlers",this),t=0;t<e.length;t++)e[t].on.call(this)},componentWillUnmount:function(){for(var e=getState("_eventHandlers",this),t=0;t<e.length;t++)e[t].off.call(this)}}],n=eventManager.mixin;if(n){for(var a,i={},r={},o=["on","once","off","trigger"],c=0;c<o.length;c++){var a=o[c];n[a]&&(i[a]=e(n[a],r))}i.getInitialState=function(){return{__events:r}},t.push(i)}return t},"state"),React.mixins.add("listen",{componentDidMount:function(){_watchedEventsUnbindAll(!0,this),_watchedEventsBindAll(this)},componentWillUnmount:function(){_watchedEventsUnbindAll(!0,this)},listenTo:function(e,t,n,a){var i=t?{event:t,callback:n,target:e,context:a}:e;manageEvent.call(this,"on",i)},listenToOnce:function(e,t,n,a){var i={event:t,callback:n,target:e,context:a};manageEvent.call(this,"once",i)},stopListening:function(e,t,n,a){var i={event:t,callback:n,target:e,context:a};manageEvent.call(this,"off",i)}})}(),function(){function e(e,t,n){return"collection"===e?t.getCollection(n):t.getModel(n)}function t(e){return e?_.isArray(e)?e:[e]:void 0}function n(t,n){return function(){return n?n:e(t,modelOrCollection)}}function a(e){return e.getModelKey?e.getModelKey():e.props.name||e.props.key||e.props.ref}function i(e,t){if(t&&t.modelIndexErrors)return t.modelIndexErrors(e);if(Array.isArray(e)){var n={};return _.each(e,function(e){for(var t in e)n[t]=e[t]}),n}return e}function r(e,t){if(e.getModel){var n=a(e),i=e.getModel();if(i)return t(n,i)}}function o(e,n,a,i,r){var o,c,s=Array.isArray(n)?n:t(a.props[n]);if(s){for(var l=0;l<s.length;l++)o=s[l],c=i.replace("{key}",o),a[e+"On"](c,_.bind(r,a),this);return s}}function c(t,n,a,i,r){var o=s(i),c=a[0],l=a[1],d=a[2];o[c]={type:n,ev:c,cb:l,ctx:d};var u=r||e(t,i);u&&i["on"===n?"listenTo":"listenToOnce"](u,c,l,d)}function s(e){var t=h("__modelEvents",e);return t||(t={},p({__modelEvents:t},e)),t}function l(e){for(var t,n=0;n<e.length;n++)t=e[n],"true"===t?t=!0:"false"===t?t=!1:t.match(/^[0-9]+$/)?t=parseInt(t):t.match(/^[0-9]+\.[0-9]+/)&&(t=parseFloat(t)),e[n]=t;return e}var d=Backbone.xhrEventName,u=Backbone.xhrCompleteEventName,f=Backbone.xhrModelLoadingAttribute,h=React.mixins.getState,p=React.mixins.setState;React.events.mixin=React.events.mixin||Backbone.Events,React.mixins.getModelKey=a,React.mixins.modelIndexErrors=i,Backbone.input=Backbone.input||{};{var v=Backbone.input.getModelValue=function(e){return r(e,function(e,t){return t.get(e)})};Backbone.input.setModelValue=function(e,t,n){return r(e,function(e,a){return a.set(e,t,n)})}}_.each([{type:"model",capType:"Model",changeEvents:["change"]},{type:"collection",capType:"Collection",changeEvents:["add","remove","reset","sort"]}],function(t){var a={};a["get"+t.capType]=function(e){return e=e||this.props,h(t.type,this)||e[t.type]},a["set"+t.capType]=function(n,a){var i=e(t.type,this,this.props),r=s(this);_.each(r,function(e){this[t.type+"Off"](e.ev,e.cb,e.ctx,i),c(t.type,e.type,[e.ev,e.cb,e.ctx],this,n)},this),a!==!0&&p(t.type,n)},React.mixins.add(t.type+"Aware",a,"state");var i={getInitialState:function(){var n=e(t.type,this);return n&&(n.off&&n.on||(console.error("the model/collection does not implement on/off functions - you will see problems"),console.log(n))),{}},componentWillReceiveProps:function(n){var a=e(t.type,this),i=e(t.type,this,n);a!==i&&this["set"+t.capType](i,!0)}};i[t.type+"On"]=function(){c(t.type,"on",arguments,this)},i[t.type+"Once"]=function(){c(t.type,"once",arguments,this)},i[t.type+"Off"]=function(e,a,i,r){var o=s(this);delete o[e],this.stopListening(n(t.type,r),e,a,i)},React.mixins.add(t.type+"Events",i,t.type+"Aware","listen","events");var r={getInitialState:function(){_.each(t.changeEvents,function(e){this[t.type+"On"](e,function(){this.deferUpdate()},this)},this)}};React.mixins.add(t.type+"ChangeAware",r,t.type+"Events","listen","events","deferUpdate");var l={getInitialState:function(){this[t.type+"On"](d,function(n,a){p({loading:!0},this);var i=e(t.type,this);a.on("success",function(){p({loading:i[f]},this)},this),a.on("error",function(e){p({loading:i[f],error:e},this)},this)});var n=e(t.type,this);return{loading:n&&n[f]}},componentDidMount:function(){var n=this.state,a=e(t.type,this);if(a){var i=a[f];i?(this[t.type+"Once"](u,function(){p({loading:!1},this)}),n.loading||p({loading:!0},this)):n.loading&&p({loading:!1},this)}}};React.mixins.add(t.type+"XHRAware",l,t.type+"Events");var v=function(){var n=arguments.length>0?Array.prototype.slice.call(arguments,0):void 0;return{getInitialState:function(){n=o(t.type,n||"loadOn",this,d+":{key}",function(n){var a=e(t.type,this);p({loading:a[f]},this),n.on("complete",function(){p({loading:!1},this)},this)});var a=e(t.type,this);if(a){var i,r=a.loading;if(r)for(var c=function(){p({loading:!1},this)},s=0;s<r.length;s++){var l=n.indexOf(r[s].method);if(l>=0)return i=n[l],r[s].on("complete",c,this),{loading:a[f]}}}return{}}}};React.mixins.add(t.type+"LoadOn",v,t.type+"Events");var m=function(){var e=arguments.length>0?Array.prototype.slice.call(arguments,0):void 0;return{getInitialState:function(){o(t.type,e||"updateOn",this,"{key}",function(){this.deferUpdate()})}}};React.mixins.add(t.type+"UpdateOn",m,t.type+"Events","deferUpdate");var g=new RegExp("^"+t.type+"([.+])?$");React.events.handle(g,function(e,n){return{on:function(){if(!this[t.type+"On"])throw new Error("use the "+t.type+' "Events" mixin instead of "events"');this[t.type+"On"](e.path,n)},off:function(){}}})}),_.each({XHRAware:"XHRAware",changeAware:"ChangeAware",loadOn:"LoadOn",updateOn:"UpdateOn"},function(e,t){React.mixins.add(t,{},"model"+e,"collection"+e)}),React.mixins.add("modelPopulate",{modelPopulate:function(){var e,t,n,i,r;_.each(arguments,function(a){a instanceof Backbone.Model?i=a:_.isBoolean(a)?(r=!0,i=!1):_.isArray(a)?e=a:_.isFunction(a)?t=a:n=a}),_.isUndefined(i)&&this.getModel&&(i=this.getModel());var o={};e||(e=_.map(this.refs,function(e){return e}));return _.each(e,function(e){if(e.getValue){var t=a(e);if(t){var c=e.getValue();o[t]=c}}else if(e.modelPopulate&&e.getModel){if(!i&&!r)return;var s=e.getModel(),l=i||n&&n.populateModel;if(s===l){var d=e.modelPopulate(_.extend({populateModel:l},n),!0);_.defaults(o,d)}}}),i&&i.set(o,{validate:!0})&&t.call(this,i),o}},"modelAware"),React.mixins.add("loadWhile",{loadWhile:function(e){function t(t){var a=e[t];e[t]=function(){p({loading:!1},n),a&&a.apply(this,arguments)}}e=e||{};var n=this;return t("error"),t("success"),p({loading:!0},this),e}}),React.mixins.add("modelValidator",{modelValidate:function(e,t){var n=this.getModel();return n&&n.validate?i(n.validate(e,t),this)||!1:void 0}},"modelAware"),React.mixins.add("modelInvalidAware",{getInitialState:function(){var e=a(this);return e&&this.modelOn("invalid",function(t,n){var a=i(n,this)||{},r=a&&a[e];r&&p({invalid:r},this)}),{}}},"modelEventAware");var m=React.events.specials;if(m){var g=["memoize","delay","defer","throttle","debounce","once","after","before"];_.each(g,function(e){m[e]=m[e]||function(t,n){return n=l(n),n.splice(0,0,t),_[e].apply(_,n)}})}var y=function(e,t,n,a){return React.createClass(_.extend({mixins:["modelAware"],render:function(){var a={},i=v(this);return n?a.defaultChecked=i:a.defaultValue=i,React.DOM[e](_.extend(a,t,this.props),this.props.children)},getValue:function(){if(this.isMounted()){if(n){var e=this.getDOMNode();return e.checked&&(e.value||!0)||!1}return $(this.getDOMNode()).val()}},getDOMValue:function(){return this.isMounted()?$(this.getDOMNode()).val():void 0}},a))};Backbone.input=Backbone.input||{},_.defaults(Backbone.input,{Text:y("input",{type:"text"}),TextArea:y("textarea"),Select:y("select",void 0,void 0),CheckBox:y("input",{type:"checkbox"},!0),RadioGroup:React.createClass({render:function(){var e=this.props;return e.ref="input",React.DOM[e.tag||"span"](e,e.children)},componentDidMount:function(){var e=v(this);if(e){var t='input[value="'+e.replace('"','\\"')+'"]',n=$(this.getDOMNode()).find(t);n.attr("checked","checked")}},getValue:function(){if(this.isMounted())for(var e='input[type="radio"]',t=$(this.getDOMNode()).find(e),n=0;n<t.length;n++)if(t[n].checked)return t[n].value},getDOMValue:function(){if(this.isMounted()){return $(this.getDOMNode()).val()}}})})}()});