/*!
 * https://github.com/jhudson8/react-backbone v0.12.0;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["react","backbone","underscore"],e):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(t,n){e(t,n,require("underscore"))}:e(React,Backbone,_)}(function(e,t,n){function i(e,t){t.isMounted()?t.setState(e):t.state?n.extend(t.state,e):t.__react_backbone_state=n.extend(t.__react_backbone_state||{},e)}function a(e,t){var n=t.state,i=t.__react_backbone_state;return n&&n[e]||i&&i[e]}function o(e){return e?n.isArray(e)?e:[e]:void 0}function r(e){return e.key||e.ref||e.props.key||e.props.ref}function d(e,t,i,a){var r,d,l=Array.isArray(e)?e:o(t.props[e]);if(l){for(var s=0;s<l.length;s++)r=l[s],d=i.replace("{key}",r),t.modelOn(d,n.bind(a,t),this);return l}}function l(e,t){t=n.extend({type:e},t);var o=a("__watchedEvents",this);if(o||(o=[],i({__watchedEvents:o},this)),t.context=t.context||this,o.push(t),this.isMounted()){var r=t.target||t.model||this.getModel();r&&r[t.type](t.event,t.callback,t.context)}}function s(e,t){if(e.getModel){var n=r(e),i=e.getModel();if(i)return t(n,i)}}function c(e){for(var t,n=0;n<e.length;n++)t=e[n],"true"===t?t=!0:"false"===t?t=!1:t.match(/^[0-9]+$/)?t=parseInt(t):t.match(/^[0-9]+\.[0-9]+/)&&(t=parseFloat(t)),e[n]=t;return e}var u=t.xhrEventName,h=t.xhrCompleteEventName,f=t.xhrModelLoadingAttribute;t.input=t.input||{};{var v=t.input.getModelValue=function(e){return s(e,function(e,t){return t.get(e)})};t.input.setModelValue=function(e,t,n){return s(e,function(e,i){return i.set(e,t,n)})}}if(e.mixins.add("modelAware",{componentWillMount:function(){var e=this.__react_backbone_state;e&&(this.state=n.extend(this.state||{},e),delete this.__react_backbone_state)},getModel:function(){return a("model",this)||a("collection",this)||this.props.model||this.props.collection},setModel:function(e){this._watchedEventsUnbindAll&&this._watchedEventsUnbindAll(!0),i({model:e},this),this._watchedEventsBindAll&&this.isMounted()&&this._watchedEventsBindAll()}}),e.mixins.add("modelPopulate",{modelPopulate:function(){var e,i,a,o;n.each(arguments,function(r){r instanceof t.Model||r===!1?o=r:n.isArray(r)?e=r:n.isFunction(r)?i=r:a=r}),n.isUndefined(o)&&this.getModel&&(o=this.getModel());var d={};e||(e=n.map(this.refs,function(e){return e}));var l={};if(n.each(e,function(e){if(e.getValue){var t=r(e);if(t){var i=e.getValue();d[t]=i}}else if(e.modelPopulate&&e.getModel){if(!o)return;var s=e.getModel();if(s){var c=e.modelPopulate(a,!1),u=l[s.cid]||{};n.extend(u,c),l[s.cid]={model:s,attr:u}}}}),o){var s=!0,c=l[o.cid];c||(c={model:o,attr:{}}),n.extend(c.attr,d),l[o.cid]=c;var u=n.defaults({validate:!0},a);n.each(l,function(e){var t=!e.model._validate(e.attr,u);s=!t&&s}),s&&(a=n.defaults({validate:!1},a),n.each(l,function(e){e.model.set(e.attr,a)})),i&&s&&i.call(this,o)}return d}},"modelAware"),e.mixins.add("modelValidator",{modelValidate:function(e,t){var n=this.getModel();return n&&n.validate?this.modelIndexErrors(n.validate(e,t))||!1:void 0}},"modelAware","modelIndexErrors"),e.mixins.add("_eventWatcher",{_watchedEventsBindAll:function(){var e=a("__watchedEvents",this);if(e){var t=this.getModel&&this.getModel();n.each(e,function(e){var n=e.target||t;n&&n[e.type](e.event,e.callback,e.context)})}},_watchedEventsUnbindAll:function(e,t){var o=a("__watchedEvents",this);if(o){var r=this.getModel&&this.getModel();n.each(o,function(e){var n=e.target||t||r;n&&n.off(e.event,e.callback,e.context)}),e||i({__watchedEvents:[]},this)}},componentDidMount:function(){this._watchedEventsUnbindAll(!0),this._watchedEventsBindAll(!0)},componentWillUnmount:function(){this._watchedEventsUnbindAll(!0)}}),e.mixins.add("listenTo",{listenTo:function(e,t,n,i){var a={event:t,callback:n,target:e,context:i};l.call(this,"on",a)},stopListening:function(e,t,n,i){var a={event:t,callback:n,target:e,context:i};l.call(this,"off",a)}},"_eventWatcher"),e.mixins.add("modelEventAware",{getInitialState:function(){return{}},componentWillReceiveProps:function(){var e=this.getModel(),t=this;n.defer(function(){var n=t.getModel();e!==n&&(t._watchedEventsUnbindAll(!0,e),t._watchedEventsBindAll())})},modelOn:function(e,t){var n=t?{event:e,callback:t}:e;l.call(this,"on",n)},modelOnce:function(e,t){var n=t?{event:e,callback:t}:e;l.call(this,"once",n)},modelOff:function(e,t){var n=t?{event:e,callback:t}:e,i=this.state.__watchedEvents;if(i)for(var a,o=0;o<i.length;o++)if(a=i[o],a.event===n.event&&a.model===n.model&&a.callback===n.callback){var r=n.target||this.getModel();r&&r.off(n.event,n.callback,n.context||this),i.splice(o,1)}}},"modelAware","_eventWatcher"),e.mixins.add("modelChangeAware",{getInitialState:function(){return n.each(["change","reset","add","remove","sort"],function(e){this.modelOn(e,function(){this.deferUpdate()})},this),null}},"modelEventAware","deferUpdate"),e.mixins.add("modelXHRAware",{getInitialState:function(){this.modelOn(u,function(e,t){i({loading:!0},this);var n=this.getModel();t.on("success",function(){i({loading:n[f]},this)},this),t.on("error",function(e){i({loading:n[f],error:e},this)},this)});var e=this.getModel();return{loading:e&&e[f]}},componentDidMount:function(){var e=this.state,t=this.getModel();if(t){var n=t[f];n?(this.modelOnce(h,function(){i({loading:!1},this)}),e.loading||i({loading:!0},this)):e.loading&&i({loading:!1},this)}}},"modelEventAware"),e.mixins.add("modelInvalidAware",{getInitialState:function(){var e=r(this);return e&&this.modelOn("invalid",function(t,n){var a=this.modelIndexErrors(n)||{},o=a&&a[e];o&&i({invalid:o},this)}),{}}},"modelIndexErrors","modelEventAware"),e.mixins.add("modelIndexErrors",{modelIndexErrors:function(e){if(Array.isArray(e)){var t={};return n.each(e,function(e){for(var n in e)t[n]=e[n]}),t}return e}}),e.mixins.add("modelLoadOn",function(){var e=arguments.length>0?Array.prototype.slice.call(arguments,0):void 0;return{getInitialState:function(){e=d(e||"loadOn",this,u+":{key}",function(e){var t=this.getModel();i({loading:t[f]},this),e.on("complete",function(){i({loading:!1},this)},this)});var t=this.getModel();if(t){var n,a=t.loading;if(a)for(var o=function(){i({loading:!1},this)},r=0;r<a.length;r++){var l=e.indexOf(a[r].method);if(l>=0)return n=e[l],a[r].on("complete",o,this),{loading:t[f]}}}return{}},loadWhile:function(e){function t(t){var a=e[t];e[t]=function(){i({loading:!1},n),a&&a.apply(this,arguments)}}e=e||{};var n=this;return t("error"),t("success"),i({loading:!0},this),e}}},"modelEventAware"),e.mixins.add("modelUpdateOn",function(){var e=arguments.length>0?Array.prototype.slice.call(arguments,0):void 0;return{getInitialState:function(){d(e||"updateOn",this,"{key}",function(){this.deferUpdate()})}}},"modelEventAware","deferUpdate"),e.events){e.events.mixin=e.events.mixin||t.Events;var m=/^model(\[.+\])?$/;e.events.handle(m,function(e,t){var n=e.key.match(m),i=n[1]&&n[1].substring(1,n[1].length-1),a=i&&(this.props[i]||this.refs[i]);if(!a&&i)throw new Error('no model found with "'+i+'"');var o={model:a,event:e.path,callback:t};return{on:function(){this.modelOn(o)},off:function(){}}});var g=e.events.specials;if(g){var p=["memoize","delay","defer","throttle","debounce","once"];n.each(p,function(e){g[e]=g[e]||function(t,i){return i=c(i),i.splice(0,0,t),n[e].apply(n,i)}})}}var x=function(t,i,a,o){return e.createClass(n.extend({mixins:["modelAware"],render:function(){var o={},r=v(this);return a?o.defaultChecked=r:o.defaultValue=r,e.DOM[t](n.extend(o,i,this.props),this.props.children)},getValue:function(){if(this.isMounted()){if(a){var e=this.getDOMNode();return e.checked&&(e.value||!0)||!1}return $(this.getDOMNode()).val()}},getDOMValue:function(){return this.isMounted()?$(this.getDOMNode()).val():void 0}},o))};t.input=t.input||{},n.defaults(t.input,{Text:x("input",{type:"text"}),TextArea:x("textarea"),Select:x("select",void 0,void 0),CheckBox:x("input",{type:"checkbox"},!0),RadioGroup:e.createClass({render:function(){var t=this.props;return t.ref="input",e.DOM[t.tag||"span"](t,t.children)},componentDidMount:function(){var e=v(this);if(e){var t='input[value="'+e.replace('"','\\"')+'"]',n=$(this.getDOMNode()).find(t);n.attr("checked","checked")}},getValue:function(){if(this.isMounted())for(var e='input[type="radio"]',t=$(this.getDOMNode()).find(e),n=0;n<t.length;n++)if(t[n].checked)return t[n].value},getDOMValue:function(){if(this.isMounted()){return $(this.getDOMNode()).val()}}})})});