/*!
 * https://github.com/jhudson8/react-backbone v0.7.1;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["react","backbone","underscore"],e):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(t,n){e(t,n,require("underscore"))}:e(React,Backbone,_)}(function(e,t,n){function i(e){return e?n.isArray(e)?e:[e]:void 0}function o(e){return e.props.key||e.props.ref}function a(e,t,o,a){var d,s,l=i(t.props[e]);if(l){for(var r=0;r<l.length;r++)d=l[r],s=o.replace("{key}",d),t.modelOn(s,n.bind(a,t),this);return l}}function d(e,t){var i,o=this;if(t=n.extend({type:e},t),this.state?(i=this.state.__modelEvents,o=this.state):i=this.__modelEvents,i||(i=o.__modelEvents=[]),t.context=t.context||this,i.push(t),this.isMounted()){var a=t.model||this.getModel();a&&a[t.type](t.event,t.callback,t.context)}}function s(e){for(var t,n=0;n<e.length;n++)t=e[n],"true"===t?t=!0:"false"===t?t=!1:t.match(/^[0-9]+$/)?t=parseInt(t):t.match(/^[0-9]+\.[0-9]+/)&&(t=parseFloat(t)),e[n]=t;return e}if(e.mixins.add("modelAware",{getModel:function(){return this.props.model},setModel:function(e){this._modelUnbindAll&&this._modelUnbindAll(!0),this.setProps({model:e}),this._modelBindAll&&this.isMounted()&&this._modelBindAll()}}),e.mixins.add("modelValueAware",{getModelValue:function(){var e=o(this),t=this.getModel();return t&&e?t.get(e):void 0},setModelValue:function(e,t){var n=o(this),i=this.getModel();return i&&n?i.set(n,e,t):void 0}},"modelAware"),e.mixins.add("modelPopulate",{modelPopulate:function(e,t,i){n.isFunction(e)&&(i=t,t=e,e=void 0);var a={};if(e||(e=n.map(this.refs,function(e){return e})),n.each(e,function(e){if(e.getUIValue){var t=o(e),n=e.getUIValue();a[t]=n}}),t&&this.getModel){var d=this.getModel();d&&d.set(a,i||{validate:!0})&&t.call(this,d)}return a}}),e.mixins.add("modelValidator",{modelValidate:function(e,t){var n=this.getModel();return n&&n.validate?this.modelIndexErrors(n.validate(e,t))||!1:void 0}},"modelAware","modelIndexErrors"),e.mixins.add("modelEventAware",{getInitialState:function(){return{}},modelOn:function(e,t){var n=t?{event:e,callback:t}:e;d.call(this,"on",n)},modelOnce:function(e,t){var n=t?{event:e,callback:t}:e;d.call(this,"once",n)},modelOff:function(e,t){var n=t?{event:e,callback:t}:e,i=this.state.__modelEvents;if(i)for(var o,a=0;a<i.length;a++)if(o=i[a],o.event===n.event&&o.model===n.model&&o.callback===n.callback){var d=n.model||this.getModel();d&&d.off(n.event,n.callback,n.context||this),i.splice(a,1)}},_modelBindAll:function(){if(this.state){var e=this.__modelEvents;if(e&&(delete this.__modelEvents,this.state.__modelEvents=e),e=this.state.__modelEvents){var t=this.getModel();n.each(e,function(e){var n=e.model||t;n&&n[e.type](e.event,e.callback,e.context)})}}},_modelUnbindAll:function(e){if(this.state){var t=this.state.__modelEvents,i=this.getModel();t&&(n.each(t,function(e){var t=e.model||i;t&&t.off(e.event,e.callback,e.context)}),e||(this.state.__modelEvents=[]))}},componentDidMount:function(){this._modelUnbindAll(!0),this._modelBindAll(!0)},componentWillUnmount:function(){this._modelUnbindAll(!0)}},"modelAware"),e.mixins.add("modelChangeAware",{getInitialState:function(){return n.each(["change","reset","add","remove","sort"],function(e){this.modelOn(e,function(){this.deferUpdate()})},this),null}},"modelEventAware","deferUpdate"),e.mixins.add("modelAsyncAware",{getInitialState:function(){this.modelOn("async",function(e,t){this.setState({loading:!0});var n=this.getModel();t.on("success",function(){this.isMounted()&&this.setState({loading:!!n.isLoading()})},this),t.on("error",function(e){this.isMounted()&&this.setState({loading:!!n.isLoading(),error:e})},this)});var e=this.getModel();return e&&e.isLoading()?{loading:!0}:{}},componentDidMount:function(){var e=this.state,t=this.getModel();t&&(t.isLoading()?(this.modelOnce("async:load-complete",function(){this.setState({loading:!1})}),e.loading||this.setState({loading:!0})):e.loading&&this.setState({loading:!1}))}},"modelEventAware"),e.mixins.add("modelInvalidAware",{getInitialState:function(){var e=o(this);return e&&this.modelOn("invalid",function(t,n){n=this.modelIndexErrors(n)||{};var i=n[e];i&&this.setState({error:i})}),{}}},"modelIndexErrors","modelEventAware"),e.mixins.add("modelIndexErrors",{modelIndexErrors:function(e){if(Array.isArray(e)){var t={};return n.each(e,function(e){for(var n in e)t[n]=e[n]}),t}return e}}),e.mixins.add("modelLoadOn",{getInitialState:function(){var e=a("loadOn",this,"async:{key}",function(e){this.setState({loading:!0}),e.on("complete",function(){this.isMounted()&&this.setState({loading:!1})},this)}),t=this.getModel();if(t){var n,i=t.isLoading();if(i)for(var o=function(){this.isMounted()&&this.setState({loading:!1})},d=0;d<i.length;d++){var s=e.indexOf(i[d].method);if(s>=0)return n=e[s],i[d].on("complete",o,this),{loading:!0}}}return{}}},"modelEventAware"),e.mixins.add("modelUpdateOn",{getInitialState:function(){a("updateOn",this,"{key}",function(){this.deferUpdate()})},updateOnModelEvent:function(){function e(){this.deferUpdate()}n.each(arguments,function(t){this.modelOn(t,e)},this)}},"modelEventAware","deferUpdate"),e.events){e.events.mixin=e.events.mixin||t.Events;var l=/^model(\[.+\])?$/;e.events.handle(l,function(e,t){var n=e.key.match(l),i=n[1]&&n[1].substring(1,n[1].length-1),o=i&&(this.props[i]||this.refs[i]);if(!o&&i)throw new Error('no model found with "'+i+'"');var a={model:o,event:e.path,callback:t};return{on:function(){this.modelOn(a)},off:function(){}}});var r=e.events.specials;if(r){var c=["memoize","delay","defer","throttle","debounce","once"];n.each(c,function(e){r[e]=r[e]||function(t,i){return i=s(i),i.splice(0,0,t),n[e].apply(n,i)}})}}});